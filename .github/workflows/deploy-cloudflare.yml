name: Deploy Cloudflare

on:
  push:
    branches:
      - dev
      - main

permissions:
  contents: read

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy-dev:
    if: github.ref_name == 'dev'
    runs-on: ubuntu-latest
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      DATABASE_URL: ${{ secrets.NEON_DATABASE_URL_DEV }}
      HYPERDRIVE_DEV_ID: ${{ secrets.HYPERDRIVE_DEV_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run migration (dev)
        run: bun run db:migrate

      - name: Inject Hyperdrive ID (dev)
        run: |
          sed -i "s|00000000-0000-4000-8000-000000000002|${HYPERDRIVE_DEV_ID}|g" services/app/wrangler.dev.jsonc

      - name: Deploy app (dev)
        run: bun run deploy:dev

  deploy-prod:
    if: github.ref_name == 'main'
    runs-on: ubuntu-latest
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      DATABASE_URL: ${{ secrets.NEON_DATABASE_URL_PROD }}
      HYPERDRIVE_PROD_ID: ${{ secrets.HYPERDRIVE_PROD_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run migration (prod)
        run: bun run db:migrate

      - name: Inject Hyperdrive ID (prod)
        run: |
          sed -i "s|00000000-0000-4000-8000-000000000001|${HYPERDRIVE_PROD_ID}|g" services/app/wrangler.prod.jsonc

      - name: Deploy app (prod)
        run: bun run deploy:prod
